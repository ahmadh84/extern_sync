IF(WIN32)
    SET(MEXEXT_CMD cmd /C mexext)
ELSE(WIN32)
    SET(MEXEXT_CMD mexext)
ENDIF(WIN32)

SET(MEX_NAME nearest_neighbors)
EXECUTE_PROCESS(COMMAND ${MEXEXT_CMD} OUTPUT_VARIABLE MEX_EXTENSION OUTPUT_STRIP_TRAILING_WHITESPACE)
SET(MEX_COMMAND mex)
SET(MEX_FILE ${CMAKE_CURRENT_BINARY_DIR}/${MEX_NAME}.${MEX_EXTENSION})

IF(WIN32)
    SET(LIB_DEP flann.dll)
ELSE(WIN32)
    SET(LIB_DEP libflann.so)
ENDIF(WIN32)

ADD_CUSTOM_COMMAND(
    OUTPUT ${MEX_FILE}
    COMMAND ${MEX_COMMAND}
    ARGS ${CMAKE_CURRENT_SOURCE_DIR}/${MEX_NAME}.cc -I${PROJECT_SOURCE_DIR}/cpp -L${PROJECT_BINARY_DIR}/cpp -lflann
    DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/${MEX_NAME}.cc ${PROJECT_BINARY_DIR}/cpp/${LIB_DEP}
    COMMENT "Building MEX extension ${MEX_FILE}"
)


ADD_CUSTOM_TARGET(mex_${MEX_NAME} ALL DEPENDS ${MEX_FILE})


FILE(GLOB MATLAB_SOURCES *.m)

INSTALL (
    FILES ${MEX_FILE} ${MATLAB_SOURCES}
    DESTINATION matlab
)

